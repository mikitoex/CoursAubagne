let appData = {};
let currentQuestions = [];
let currentQuestionIndex = 0;
let score = 0;
let currentCategoryKey = "";

// C'est cette partie qui va chercher tes modifications
document.addEventListener('DOMContentLoaded', () => {
    // On ajoute un petit code (?t=...) pour forcer la mise √† jour imm√©diate
    fetch('quiz.json?t=' + Date.now())
        .then(response => {
            if (!response.ok) { throw new Error("Fichier introuvable"); }
            return response.json();
        })
        .then(data => {
            appData = data;
            generateMenu();
        })
        .catch(err => {
            console.error(err);
            document.getElementById('menu-grid').innerHTML = "<p>Chargement...</p>";
        });
});

function generateMenu() {
    const grid = document.getElementById('menu-grid');
    if (!grid) return;
    
    grid.innerHTML = ""; // On vide les anciennes cartes (comme "Bient√¥t...")

    // On cr√©e les nouvelles cartes depuis quiz.json
    if (appData.categories) {
        appData.categories.forEach(category => {
            const count = category.questions ? category.questions.length : 0;
            const card = document.createElement('div');
            card.className = count === 0 ? 'card locked' : 'card';
            
            if (count > 0) {
                card.onclick = () => startQuiz(category);
            } else {
                card.onclick = () => alert("En construction !");
            }

            card.innerHTML = `
                <div class="icon">${category.icon || 'üìù'}</div>
                <h3>${category.title}</h3>
                <p>${count} Questions</p>
            `;
            grid.appendChild(card);
        });
    }
}

function startQuiz(categoryObj) {
    currentQuestions = categoryObj.questions;
    currentCategoryKey = categoryObj.key;
    currentQuestionIndex = 0;
    score = 0;
    document.getElementById('category-badge').innerText = categoryObj.title;
    showScreen('quiz-screen');
    loadQuestion();
}

function loadQuestion() {
    document.getElementById('feedback-box').className = "hidden";
    const optionsContainer = document.getElementById('options-container');
    optionsContainer.innerHTML = "";

    const questionObj = currentQuestions[currentQuestionIndex];
    document.getElementById('question-text').innerText = questionObj.question;
    document.getElementById('progress').innerText = `${currentQuestionIndex + 1} / ${currentQuestions.length}`;

    questionObj.options.forEach(option => {
        const button = document.createElement('button');
        button.innerText = option;
        button.className = 'option-btn';
        button.onclick = () => checkAnswer(option, button);
        optionsContainer.appendChild(button);
    });
}

function checkAnswer(selectedOption, btnElement) {
    const questionObj = currentQuestions[currentQuestionIndex];
    const feedbackBox = document.getElementById('feedback-box');
    const allButtons = document.querySelectorAll('.option-btn');
    
    allButtons.forEach(btn => btn.disabled = true);

    if (selectedOption === questionObj.answer) {
        score++;
        btnElement.style.backgroundColor = "#d4edda";
        btnElement.style.borderColor = "#28a745";
        document.getElementById('feedback-title').innerText = "‚úÖ Bonne r√©ponse !";
        feedbackBox.classList.add('correct');
        feedbackBox.classList.remove('wrong');
    } else {
        btnElement.style.backgroundColor = "#f8d7da";
        btnElement.style.borderColor = "#dc3545";
        document.getElementById('feedback-title').innerText = "‚ùå Faux !";
        feedbackBox.classList.add('wrong');
        feedbackBox.classList.remove('correct');
        
        allButtons.forEach(btn => {
            if (btn.innerText === questionObj.answer) {
                btn.style.backgroundColor = "#d4edda";
                btn.style.borderColor = "#28a745";
            }
        });
    }
    
    document.getElementById('feedback-text').innerText = questionObj.explanation || "";
    feedbackBox.classList.remove('hidden');
}

function nextQuestion() {
    currentQuestionIndex++;
    if (currentQuestionIndex < currentQuestions.length) {
        loadQuestion();
    } else {
        showResults();
    }
}

function showResults() {
    document.getElementById('score').innerText = score;
    document.getElementById('total-questions').innerText = currentQuestions.length;
    
    const rewardSection = document.getElementById('reward-section');
    const pdfLink = document.getElementById('pdf-link');
    const currentCategory = appData.categories.find(c => c.key === currentCategoryKey);

    if (currentCategory && currentCategory.pdf) {
        rewardSection.classList.remove('hidden');
        // On nettoie le lien du PDF
        let pdfPath = currentCategory.pdf.startsWith('/') ? currentCategory.pdf.substring(1) : currentCategory.pdf;
        pdfLink.href = pdfPath;
        pdfLink.setAttribute('download', pdfPath);
    } else {
        rewardSection.classList.add('hidden');
    }
    showScreen('result-screen');
}

function returnToHome() {
    showScreen('category-screen');
}

function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}
